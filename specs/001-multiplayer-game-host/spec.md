# 기능 명세: 멀티플레이어 게임 진행 시스템

**Feature Branch**: `001-multiplayer-game-host`
**Created**: 2025-10-22
**Status**: Draft
**Input**: User description: "README.md 및 kaboom 웹 프로젝트(https://www.playkaboom.com/)를 참고하여 다수의 플레이어가 한 게임 세션에 접속하여 두개의 방, 한개의 폭탄 보드게임을 즐길 수 있는 게임 진행 보조 도구를 구현하고자 한다."

## Clarifications

### Session 2025-10-22

- Q: 플레이어 닉네임 입력 방식은? → A: 선택적 닉네임 입력 - 기본 익명 닉네임 제공, 원하면 변경 가능
- Q: 인질 교환의 "방장" 정의는? → A: 각 방마다 리더 존재 - 빨간 방 리더와 파란 방 리더가 각자 인질 선택

## 용어 정의 (Terminology)

본 문서에서 사용되는 핵심 용어는 다음과 같이 정의됩니다:

- **방장 (Room Owner/Host)**: 게임 방을 생성한 플레이어. 게임 시작 버튼, 라운드 설정 등 게임 전체 설정에 대한 권한을 보유합니다.
- **빨간 방 리더 (Red Room Leader)**: 각 라운드마다 빨간 방에 자동 지정되는 플레이어. 해당 라운드의 인질 선택 권한을 보유합니다.
- **파란 방 리더 (Blue Room Leader)**: 각 라운드마다 파란 방에 자동 지정되는 플레이어. 해당 라운드의 인질 선택 권한을 보유합니다.

**Note**: "방장"과 "리더"는 서로 다른 역할입니다. 방장은 게임 전체를 관리하고, 리더는 라운드별 인질 선택만 담당합니다.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 방 생성 및 플레이어 입장 (Priority: P1)

방장이 새로운 게임 방을 생성하고, 다른 플레이어들이 고유 코드를 통해 해당 방에 입장하여 게임을 시작할 수 있다.

**Why this priority**: 게임의 가장 기본적인 전제조건으로, 플레이어들이 모이지 않으면 게임이 불가능하다. 이 스토리만으로도 멀티플레이어 로비 기능을 검증할 수 있다.

**Independent Test**: 방장이 방을 생성하고 고유 코드를 받아, 다른 기기에서 해당 코드로 입장하여 플레이어 목록에 표시되는지 확인한다. 최소 2명의 플레이어가 동일한 대기실에 있으면 성공이다.

**Acceptance Scenarios**:

1. **Given** 사용자가 홈 화면에 있을 때, **When** "방 만들기" 버튼을 클릭하면, **Then** 자동으로 익명 닉네임(예: 플레이어1)이 부여되고, 고유한 6자리 방 코드가 생성되며, 방장으로 대기실에 입장한다.
2. **Given** 방 코드를 받은 플레이어가 홈 화면에 있을 때, **When** "방 참가" 버튼을 클릭하고 방 코드를 입력하면, **Then** 자동으로 익명 닉네임(예: 플레이어2)이 부여되고 해당 방의 대기실로 입장하며 모든 참가자에게 실시간으로 표시된다.
3. **Given** 플레이어가 대기실에 입장한 후, **When** 자신의 닉네임을 클릭하면, **Then** 닉네임 변경 입력 필드가 표시되고 원하는 닉네임으로 변경할 수 있다.
4. **Given** 대기실에 3명의 플레이어가 있을 때, **When** 한 명이 나가면, **Then** 남은 플레이어들의 화면에서 해당 플레이어가 즉시 제거된다.
5. **Given** 대기실에 최소 6명의 플레이어가 있을 때, **When** 방장이 "게임 시작" 버튼을 클릭하면, **Then** 모든 플레이어가 게임 화면으로 전환된다.
6. **Given** 존재하지 않는 방 코드를 입력했을 때, **When** 입장을 시도하면, **Then** "방을 찾을 수 없습니다" 오류 메시지가 표시된다.

---

### User Story 2 - 역할 카드 배분 및 확인 (Priority: P2)

게임 시작 시 각 플레이어에게 비밀 역할 카드가 자동으로 배분되고, 플레이어는 자신의 역할만 확인할 수 있다.

**Why this priority**: 게임의 핵심 메커니즘인 역할 기반 플레이를 가능하게 한다. P1 스토리로 플레이어가 모였다면, 이 스토리로 실제 게임 플레이를 시작할 수 있다.

**Independent Test**: 게임 시작 후 각 플레이어가 자신의 화면에서 역할 카드를 확인하고, 레드 팀과 블루 팀이 적절히 분배되었는지, 대통령과 폭파범이 정확히 한 명씩 존재하는지 검증한다.

**Acceptance Scenarios**:

1. **Given** 6명의 플레이어가 대기실에 있을 때, **When** 방장이 게임을 시작하면, **Then** 각 플레이어는 레드 팀 또는 블루 팀으로 배정되고 자신의 역할 카드를 확인한다.
2. **Given** 게임이 시작되었을 때, **When** 플레이어가 자신의 역할 카드를 탭하면, **Then** 역할 이름(예: 대통령, 폭파범, 일반 레드, 일반 블루)과 팀 색상이 명확히 표시된다.
3. **Given** 10명의 플레이어로 게임이 시작되었을 때, **When** 역할 배분이 완료되면, **Then** 정확히 1명의 대통령(블루 팀)과 1명의 폭파범(레드 팀)이 존재하며, 나머지는 일반 역할로 팀이 균형있게 배분된다.
4. **Given** 플레이어가 자신의 역할을 확인한 후, **When** 다른 플레이어의 화면을 볼 수 없는 상태에서, **Then** 다른 플레이어의 역할 정보는 노출되지 않는다.

---

### User Story 3 - 라운드 타이머 및 게임 진행 (Priority: P3)

게임은 여러 라운드로 진행되며, 각 라운드마다 제한 시간이 표시되고 자동으로 다음 라운드로 전환된다.

**Why this priority**: 게임의 시간 압박 요소를 구현하여 실제 보드게임의 긴장감을 재현한다. P1과 P2로 게임의 기본 흐름이 완성되었다면, 이 스토리로 게임 경험을 향상시킨다.

**Independent Test**: 게임 시작 후 라운드 1의 타이머가 시작되고, 시간이 종료되면 자동으로 라운드 2로 전환되며, 모든 플레이어 화면에 동기화된 타이머가 표시되는지 확인한다.

**Acceptance Scenarios**:

1. **Given** 게임이 시작되었을 때, **When** 라운드 1이 시작되면, **Then** 모든 플레이어 화면에 라운드 번호와 남은 시간이 실시간으로 표시된다.
2. **Given** 라운드 1의 타이머가 3분으로 설정되었을 때, **When** 3분이 경과하면, **Then** 자동으로 라운드 2로 전환되고 타이머가 리셋된다.
3. **Given** 게임 진행 중일 때, **When** 방장이 "다음 라운드" 버튼을 클릭하면, **Then** 현재 라운드가 즉시 종료되고 다음 라운드로 전환된다.
4. **Given** 마지막 라운드(예: 라운드 5)가 종료되었을 때, **When** 타이머가 끝나면, **Then** 게임 결과 화면으로 전환된다.
5. **Given** 라운드가 진행 중일 때, **When** 타이머가 30초 이하로 남았을 때, **Then** 타이머 색상이 변경되거나 경고 표시가 나타난다.

---

### User Story 4 - 두 방 분배 및 인질 교환 (Priority: P4)

각 라운드마다 플레이어들은 빨간 방과 파란 방으로 자동 분배되며, 각 방에는 리더가 지정된다. 라운드 종료 시 각 방의 리더가 선택한 인질들이 방을 교환한다.

**Why this priority**: 게임의 핵심 메커니즘인 방 분배와 인질 교환을 구현한다. 이전 스토리들로 게임 흐름이 완성되었다면, 이 스토리로 실제 게임 규칙을 완전히 구현한다.

**Independent Test**: 게임 시작 시 플레이어들이 두 방으로 분배되고, 라운드 종료 시 각 방의 리더들이 인질을 선택하여 교환하면, 다음 라운드에서 해당 플레이어들이 반대편 방에 있는지 확인한다.

**Acceptance Scenarios**:

1. **Given** 게임이 시작되었을 때, **When** 라운드 1이 시작되면, **Then** 플레이어들이 빨간 방과 파란 방으로 가능한 균등하게 분배되고, 각 방에 리더가 자동으로 지정된다.
2. **Given** 플레이어가 빨간 방에 배정되었을 때, **When** 자신의 화면을 확인하면, **Then** 자신이 속한 방 이름, 같은 방에 있는 다른 플레이어 목록, 그리고 현재 방의 리더가 누구인지 표시된다.
3. **Given** 라운드가 종료되었을 때, **When** 빨간 방 리더와 파란 방 리더가 각자의 방에서 인질 교환을 위해 설정된 수만큼 선택하면, **Then** 선택된 플레이어들은 다음 라운드에서 반대편 방으로 이동한다.
4. **Given** 라운드 3에서 인질 교환 시간일 때, **When** 리더가 교환할 인질 수를 확인하면, **Then** 방장이 설정한 인질 교환 패턴에 따라 교환 가능한 인질 수가 표시된다.
5. **Given** 인질 교환이 완료되었을 때, **When** 다음 라운드가 시작되면, **Then** 교환된 플레이어들은 새로운 방에서 게임을 계속 진행한다.

---

### User Story 5 - 게임 결과 판정 (Priority: P5)

마지막 라운드 종료 시 대통령과 폭파범이 같은 방에 있는지 확인하여 승리 팀을 자동으로 판정하고 결과를 표시한다.

**Why this priority**: 게임의 최종 목표를 달성하고 승패를 명확히 한다. 모든 게임 메커니즘이 구현된 후 최종 완성도를 높인다.

**Independent Test**: 마지막 라운드 종료 시 대통령과 폭파범의 위치를 확인하고, 같은 방에 있으면 레드 팀 승리, 다른 방에 있으면 블루 팀 승리를 표시하는지 검증한다.

**Acceptance Scenarios**:

1. **Given** 마지막 라운드가 종료되었을 때, **When** 대통령과 폭파범이 같은 방에 있으면, **Then** "레드 팀 승리!" 메시지가 모든 플레이어에게 표시된다.
2. **Given** 마지막 라운드가 종료되었을 때, **When** 대통령과 폭파범이 다른 방에 있으면, **Then** "블루 팀 승리!" 메시지가 모든 플레이어에게 표시된다.
3. **Given** 게임 결과 화면이 표시되었을 때, **When** 플레이어가 결과를 확인하면, **Then** 각 플레이어의 역할, 소속 팀, 최종 위치가 공개된다.
4. **Given** 게임 결과 화면에서, **When** 방장이 "새 게임 시작" 버튼을 클릭하면, **Then** 모든 플레이어가 대기실로 돌아가고 새로운 게임을 시작할 수 있다.

---

### Edge Cases

- **플레이어 연결 끊김**: 게임 진행 중 플레이어의 연결이 끊어진 경우, 일정 시간(예: 30초) 내에 재접속하지 않으면 해당 플레이어를 게임에서 제외하고 계속 진행한다.
- **최소 플레이어 수 미달**: 게임 시작 전 또는 진행 중 플레이어 수가 6명 미만으로 줄어들면 게임을 진행할 수 없다는 경고를 표시하고 대기실로 돌아간다.
- **방장 퇴장**: 게임 방 전체의 방장(방 생성자)이 퇴장하면 대기실에서 가장 먼저 입장한 플레이어에게 자동으로 권한이 이전된다. 게임 진행 중 각 방(빨간 방/파란 방)의 리더가 퇴장하면 해당 방의 플레이어 목록에서 다음 순서 플레이어(리스트 상 다음 인덱스)에게 리더 권한이 이전된다.
- **동시 입장 시도**: 여러 플레이어가 동시에 같은 방 코드로 입장을 시도해도 모두 성공적으로 입장하고 중복이나 충돌 없이 목록에 표시된다.
- **잘못된 방 코드**: 존재하지 않거나 이미 시작된 게임의 방 코드를 입력하면 적절한 오류 메시지를 표시한다.
- **타이머 동기화 오류**: 네트워크 지연으로 인해 플레이어 간 타이머가 1-2초 차이가 날 수 있으나, 라운드 전환은 서버 기준으로 동기화되어야 한다.
- **인질 선택 제한 시간 초과**: 리더가 제한 시간(60초) 내에 인질을 선택하지 않으면 시스템이 자동으로 해당 방의 플레이어 중에서 무작위로 인질을 선택하여 교환을 진행한다.
- **닉네임 중복**: 같은 방에 동일한 닉네임을 사용하는 플레이어가 있을 경우, 시스템은 자동으로 숫자를 추가하여 구분한다(예: 플레이어, 플레이어(2)).

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 시스템은 방장이 고유한 6자리 영숫자 방 코드를 가진 게임 방을 생성할 수 있어야 한다.
- **FR-002**: 시스템은 플레이어가 방 코드를 입력하여 해당 게임 방에 입장할 수 있어야 한다.
- **FR-021**: 시스템은 플레이어 입장 시 자동으로 익명 닉네임을 부여해야 한다(예: 플레이어1, 플레이어2 등).
- **FR-022**: 시스템은 플레이어가 대기실에서 자신의 닉네임을 변경할 수 있도록 해야 한다.
- **FR-023**: 시스템은 닉네임 중복 시 자동으로 숫자를 추가하여 고유성을 보장해야 한다.
- **FR-003**: 시스템은 대기실에서 현재 참가한 플레이어 목록을 실시간으로 표시해야 한다.
- **FR-004**: 시스템은 방장만 "게임 시작" 버튼을 활성화하고, 최소 6명의 플레이어가 있을 때만 게임을 시작할 수 있어야 한다.
- **FR-005**: 시스템은 게임 시작 시 플레이어들을 레드 팀과 블루 팀으로 가능한 균등하게 배정해야 한다. 홀수 플레이어의 경우 레드 팀이 1명 더 많도록 배정한다.
- **FR-006**: 시스템은 정확히 1명의 대통령(블루 팀)과 1명의 폭파범(레드 팀)을 무작위로 배정해야 한다.
- **FR-007**: 시스템은 각 플레이어에게 자신의 역할만 표시하고 다른 플레이어의 역할은 숨겨야 한다.
- **FR-008**: 시스템은 게임 시작 시 플레이어들을 빨간 방과 파란 방으로 무작위 분배해야 한다.
- **FR-024**: 시스템은 각 방(빨간 방, 파란 방)에 리더를 자동으로 지정해야 한다.
- **FR-025**: 시스템은 각 방의 리더가 누구인지 해당 방의 모든 플레이어에게 표시해야 한다.
- **FR-009**: 시스템은 각 라운드마다 제한 시간을 표시하고 카운트다운해야 한다.
- **FR-010**: 시스템은 라운드 타이머가 0이 되면 자동으로 다음 라운드로 전환해야 한다.
- **FR-011**: 시스템은 라운드 종료 시 각 방의 리더가 자신의 방에서 인질을 선택할 수 있는 인터페이스를 제공해야 한다.
- **FR-011.1**: 시스템은 인질 선택 제한 시간(60초)을 제공하고, 시간 내에 리더가 선택하지 않으면 자동으로 해당 방의 플레이어 중에서 무작위로 인질을 선택해야 한다.
- **FR-012**: 시스템은 방장이 설정한 인질 교환 패턴에 따라 라운드별 교환 가능한 인질 수를 자동으로 결정해야 한다. 방장은 게임 시작 전 다음 중 하나를 선택할 수 있다:
  - **(1) 고정 (FIXED)**: 모든 라운드에서 각 방당 1명씩 교환
  - **(2) 점진적 증가 (PROGRESSIVE)** [기본값]: 라운드 1-2는 각 방당 1명, 라운드 3-4는 각 방당 2명, 라운드 5 이상은 각 방당 3명
  - **(3) 후반 집중 (LATE_SURGE)**: 라운드 1-3은 각 방당 1명, 라운드 4 이상은 각 방당 3명
- **FR-013**: 시스템은 마지막 라운드 종료 시 대통령과 폭파범의 위치를 비교하여 승리 팀을 자동 판정해야 한다.
- **FR-014**: 시스템은 게임 결과 화면에서 모든 플레이어의 역할과 팀을 공개해야 한다.
- **FR-015**: 시스템은 플레이어 연결 상태를 모니터링하고 연결 끊김 시 PLAYER_DISCONNECTED WebSocket 메시지를 통해 다른 플레이어들에게 알려야 한다.
- **FR-016**: 시스템은 방장 퇴장 시 자동으로 다음 플레이어에게 방장 권한을 이전해야 한다.
- **FR-017**: 시스템은 게임 진행 중 플레이어 수가 6명 미만으로 줄어들면 경고를 표시하고 게임을 중단할 수 있어야 한다.
- **FR-018**: 시스템은 존재하지 않는 방 코드 입력 시 적절한 오류 메시지를 표시해야 한다.
- **FR-019**: 시스템은 모든 플레이어에게 실시간으로 게임 상태 변경(라운드 전환, 인질 교환 등)을 동기화해야 한다.
- **FR-020**: 시스템은 라운드 설정(라운드 수, 각 라운드 시간)을 방장이 게임 시작 전에 조정할 수 있어야 한다.

### Key Entities

- **게임 방 (Game Room)**: 고유 방 코드, 방장 정보, 참가 플레이어 목록, 게임 설정(라운드 수, 라운드 시간), 현재 게임 상태(대기 중/진행 중/종료)
- **플레이어 (Player)**: 닉네임(기본 익명, 변경 가능), 연결 상태, 방장 여부
- **게임 세션 (Game Session)**: 참가 플레이어 목록, 현재 라운드 번호, 라운드 시작 시간, 팀 배정 정보, 방 배정 정보
- **역할 카드 (Role Card)**: 역할 이름(대통령, 폭파범, 일반), 팀 색상(레드/블루), 배정된 플레이어
- **방 (Room in Game)**: 방 이름(빨간 방/파란 방), 현재 라운드의 플레이어 목록, 리더 정보
- **인질 교환 (Hostage Exchange)**: 라운드 번호, 교환할 플레이어 목록, 빨간 방 리더 선택 정보, 파란 방 리더 선택 정보
- **게임 결과 (Game Result)**: 승리 팀, 각 플레이어의 최종 역할 및 위치, 게임 종료 시간

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 플레이어는 방 생성 후 10초 이내에 방 코드를 받고 대기실에 입장할 수 있다.
- **SC-002**: 플레이어가 방 코드를 입력한 후 5초 이내에 대기실에 입장하고 다른 플레이어들에게 표시된다.
- **SC-003**: 시스템은 최소 20명의 동시 플레이어(4개 방, 각 방당 5명)를 지원한다.
- **SC-004**: 게임 시작 시 모든 플레이어가 3초 이내에 역할 카드를 받고 게임 화면으로 전환된다.
- **SC-005**: 라운드 타이머는 모든 플레이어 화면에서 1초 이하의 오차로 동기화된다.
- **SC-006**: 라운드 전환 및 인질 교환은 2초 이내에 모든 플레이어에게 반영된다.
- **SC-007**: 게임 진행 중 한 플레이어의 연결이 끊어져도 나머지 플레이어들은 지연 없이 게임을 계속 진행할 수 있다.
- **SC-008**: 게임 결과 판정 및 화면 전환은 마지막 라운드 종료 후 3초 이내에 완료된다.
- **SC-009**: 90% 이상의 사용자가 별도의 도움말 없이 방 생성 및 입장을 완료할 수 있다.
- **SC-010**: 플레이어는 게임 한 세션(5라운드)을 15분 이내에 완료할 수 있다.

## Assumptions

- 플레이어들은 게임 규칙을 이미 알고 있으며, 게임 내 규칙 설명은 최소한으로 제공한다.
- 플레이어들은 안정적인 인터넷 연결을 가지고 있으며, 일시적인 연결 끊김은 30초 이내에 복구 가능하다고 가정한다.
- 한 게임 방의 최대 플레이어 수는 30명으로 제한한다(보드게임 권장 인원 범위 고려).
- 방 코드는 서버 실행 시간 동안 유효하며, 서버 재시작 시 모든 방이 삭제된다. 게임 종료된 방은 1시간 후 재사용 가능하다. (MVP에서는 자동 만료 메커니즘 미구현)
- 플레이어는 데스크톱 브라우저 또는 모바일 브라우저에서 접속하며, 별도의 앱 설치는 필요하지 않다.
- 게임 데이터(플레이어 정보, 역할 배정)는 게임 세션이 종료되면 삭제되며, 영구 저장하지 않는다.
- 기본 라운드 설정은 5라운드이며, 각 라운드 시간은 3분으로 설정한다(방장이 조정 가능).
- 인질 교환 시간은 라운드 종료 후 1분으로 설정하며, 시간 내에 선택하지 않으면 자동으로 무작위 선택된다.
- 인질 교환 패턴의 기본값은 "점진적 증가 (PROGRESSIVE)"이다. 자세한 패턴별 규칙은 FR-012 참조. 방장은 게임 시작 전 다른 패턴으로 변경 가능하다.
- 익명 닉네임은 "플레이어X" 형식으로 자동 생성되며, 플레이어는 대기실에서 언제든지 변경 가능하다.
- 닉네임 길이는 최소 2자, 최대 20자로 제한한다.

## Out of Scope

다음 기능들은 이번 구현 범위에 포함되지 않습니다:

- 사용자 계정 시스템 및 로그인 기능
- 게임 통계 및 전적 기록
- 친구 목록 및 초대 기능
- 채팅 또는 음성 통화 기능(플레이어들은 별도의 통신 수단 사용)
- 커스텀 역할 카드 제작 기능
- 게임 리플레이 기능
- 모바일 앱 버전(웹 브라우저 기반만 제공)
- 다국어 지원(한국어만 지원)
- 게임 내 튜토리얼 또는 인터랙티브 가이드
- 방 비밀번호 또는 초대 전용 방 기능
