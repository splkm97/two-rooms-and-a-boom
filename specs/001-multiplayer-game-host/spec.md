# 기능 명세: 멀티플레이어 역할 배분 시스템

**Feature Branch**: `001-multiplayer-game-host`
**Created**: 2025-10-22
**Status**: Draft
**Input**: User description: "README.md 및 kaboom 웹 프로젝트(https://www.playkaboom.com/)를 참고하여 다수의 플레이어가 한 게임 세션에 접속하여 두개의 방, 한개의 폭탄 보드게임을 즐길 수 있는 역할 배분 도구를 구현하고자 한다."

## Clarifications

### Session 2025-10-22

- Q: 플레이어 닉네임 입력 방식은? → A: 선택적 닉네임 입력 - 기본 익명 닉네임 제공, 원하면 변경 가능
- Q: 게임 진행 방식은? → A: 시스템은 역할 배분과 방 배정만 수행. 실제 게임은 오프라인에서 플레이어들이 직접 진행
- Q: 역할 공개 방식은? → A: 시스템에서 역할 공개 기능 없음. 플레이어들이 오프라인에서 직접 역할 카드를 보여주며 정보 교환

## 용어 정의 (Terminology)

본 문서에서 사용되는 핵심 용어는 다음과 같이 정의됩니다:

- **방장 (Room Owner/Host)**: 게임 방을 생성한 플레이어. 게임 시작 권한을 보유합니다.
- **역할 카드 (Role Card)**: 각 플레이어에게 배정되는 역할 (대통령, 폭파범, 요원, 스파이)
- **빨간 방 / 파란 방 (Red Room / Blue Room)**: 게임 시작 시 플레이어들이 무작위로 배정되는 두 개의 방
- **레드 팀 / 블루 팀 (Red Team / Blue Team)**: 플레이어의 진영
- **스파이 (Spy)**: 진영 정보 교환 시 상대편으로 보이고, 전체 정보 교환 시 스파이 신분이 공개되는 특수 역할

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 방 생성 및 플레이어 입장 (Priority: P1)

방장이 새로운 게임 방을 생성하고, 다른 플레이어들이 고유 코드를 통해 해당 방에 입장하여 대기할 수 있다.

**Why this priority**: 게임의 가장 기본적인 전제조건으로, 플레이어들이 모이지 않으면 게임이 불가능하다. 이 스토리만으로도 멀티플레이어 로비 기능을 검증할 수 있다.

**Independent Test**: 방장이 방을 생성하고 고유 코드를 받아, 다른 기기에서 해당 코드로 입장하여 플레이어 목록에 표시되는지 확인한다. 최소 2명의 플레이어가 동일한 대기실에 있으면 성공이다.

**Acceptance Scenarios**:

1. **Given** 사용자가 홈 화면에 있을 때, **When** "방 만들기" 버튼을 클릭하면, **Then** 자동으로 익명 닉네임(예: 플레이어1)이 부여되고, 고유한 6자리 방 코드가 생성되며, 방장으로 대기실에 입장한다.
2. **Given** 방 코드를 받은 플레이어가 홈 화면에 있을 때, **When** "방 참가" 버튼을 클릭하고 방 코드를 입력하면, **Then** 자동으로 익명 닉네임(예: 플레이어2)이 부여되고 해당 방의 대기실로 입장하며 모든 참가자에게 실시간으로 표시된다.
3. **Given** 플레이어가 대기실에 입장한 후, **When** 자신의 닉네임을 클릭하면, **Then** 닉네임 변경 입력 필드가 표시되고 원하는 닉네임으로 변경할 수 있다.
4. **Given** 대기실에 3명의 플레이어가 있을 때, **When** 한 명이 나가면, **Then** 남은 플레이어들의 화면에서 해당 플레이어가 즉시 제거된다.
5. **Given** 대기실에 최소 6명의 플레이어가 있을 때, **When** 방장이 "게임 시작" 버튼을 클릭하면, **Then** 모든 플레이어가 게임 화면으로 전환된다.
6. **Given** 존재하지 않는 방 코드를 입력했을 때, **When** 입장을 시도하면, **Then** "방을 찾을 수 없습니다" 오류 메시지가 표시된다.

---

### User Story 2 - 역할 배분 및 방 배정 (Priority: P2)

게임 시작 시 각 플레이어에게 역할 카드가 자동으로 배분되고, 플레이어들은 빨간 방 또는 파란 방에 무작위로 배정된다. 각 플레이어는 자신의 역할과 자신이 속한 방만 확인할 수 있다.

**Why this priority**: 게임의 핵심 기능인 역할 배분과 방 배정을 구현한다. 이 스토리가 완료되면 오프라인 게임 플레이가 가능하다.

**Independent Test**: 게임 시작 후 각 플레이어가 자신의 화면에서 역할 카드와 방 배정을 확인하고, 대통령과 폭파범이 정확히 한 명씩 존재하는지, 각 팀에 스파이가 포함되어 있는지, 빨간 방과 파란 방에 플레이어가 균등하게 분배되었는지 검증한다.

**Acceptance Scenarios**:

1. **Given** 8명의 플레이어가 대기실에 있을 때, **When** 방장이 게임을 시작하면, **Then** 각 플레이어는 레드 팀 또는 블루 팀으로 배정되고, 빨간 방 또는 파란 방에 무작위로 배치되며, 자신의 역할 카드를 확인한다.
2. **Given** 게임이 시작되었을 때, **When** 플레이어가 자신의 게임 화면을 확인하면, **Then** 역할 이름(예: 대통령, 폭파범, 레드 팀 요원, 레드 팀 스파이 등), 팀 색상, 자신이 속한 방(빨간 방/파란 방), 같은 방에 있는 플레이어 목록이 명확히 표시된다.
3. **Given** 10명의 플레이어로 게임이 시작되었을 때, **When** 역할 배분이 완료되면, **Then** 정확히 1명의 대통령(블루 팀)과 1명의 폭파범(레드 팀)이 존재하며, 각 팀에는 최소 1명의 스파이가 포함되고, 나머지는 일반 요원으로 배분된다.
4. **Given** 플레이어가 자신의 역할을 확인한 후, **When** 다른 플레이어의 화면을 볼 수 없는 상태에서, **Then** 다른 플레이어의 역할 정보는 노출되지 않는다.
5. **Given** 게임이 시작되고 방 배정이 완료되었을 때, **When** 플레이어 수를 확인하면, **Then** 빨간 방과 파란 방에 플레이어가 가능한 균등하게 분배되어 있다(홀수인 경우 ±1명 차이).

---

### User Story 3 - 게임 종료 및 재시작 (Priority: P3)

오프라인 게임이 끝난 후, 방장이 대기실로 돌아가 새로운 게임을 시작할 수 있다.

**Why this priority**: 플레이어들이 여러 라운드의 게임을 연속으로 플레이할 수 있도록 한다.

**Independent Test**: 게임 화면에서 방장이 "대기실로 돌아가기" 버튼을 클릭하면 모든 플레이어가 대기실로 돌아가고, 다시 게임을 시작할 수 있는지 확인한다.

**Acceptance Scenarios**:

1. **Given** 게임이 진행 중일 때, **When** 방장이 "대기실로 돌아가기" 버튼을 클릭하면, **Then** 모든 플레이어가 대기실로 돌아간다.
2. **Given** 플레이어들이 대기실로 돌아왔을 때, **When** 새로운 플레이어가 추가로 입장하거나 기존 플레이어가 퇴장할 수 있으며, **Then** 방장이 다시 "게임 시작" 버튼을 클릭하면 새로운 역할 배분과 방 배정이 이루어진다.

---

### Edge Cases

- **플레이어 연결 끊김**: 게임 진행 중 플레이어의 연결이 끊어진 경우, 30초의 재접속 유예 기간을 제공한다 (FR-020). 유예 기간 내 재접속하지 않으면 해당 플레이어를 게임에서 제외하고 계속 진행한다.
- **최소 플레이어 수 미달**: 게임 시작 전 플레이어 수가 6명 미만이면 게임을 시작할 수 없다는 경고를 표시한다.
- **방장 퇴장**: 게임 방의 방장이 퇴장하면 대기실에서 가장 먼저 입장한 플레이어에게 자동으로 권한이 이전된다.
- **동시 입장 시도**: 여러 플레이어가 동시에 같은 방 코드로 입장을 시도해도 모두 성공적으로 입장하고 중복이나 충돌 없이 목록에 표시된다.
- **잘못된 방 코드**: 존재하지 않거나 이미 시작된 게임의 방 코드를 입력하면 적절한 오류 메시지를 표시한다.
- **닉네임 중복**: 같은 방에 동일한 닉네임을 사용하는 플레이어가 있을 경우, 시스템은 자동으로 숫자를 추가하여 구분한다(예: 플레이어, 플레이어(2)).

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 시스템은 방장이 고유한 6자리 영숫자 방 코드를 가진 게임 방을 생성할 수 있어야 한다.
- **FR-002**: 시스템은 플레이어가 방 코드를 입력하여 해당 게임 방에 입장할 수 있어야 한다.
- **FR-003**: 시스템은 플레이어 입장 시 자동으로 익명 닉네임을 부여해야 한다(예: 플레이어1, 플레이어2 등).
- **FR-004**: 시스템은 플레이어가 대기실에서 자신의 닉네임을 변경할 수 있도록 해야 한다.
- **FR-005**: 시스템은 닉네임 중복 시 자동으로 숫자를 추가하여 고유성을 보장해야 한다. 닉네임은 2-20자이며 영문, 한글, 숫자만 허용한다.
- **FR-006**: 시스템은 대기실에서 현재 참가한 플레이어 목록을 실시간으로 표시해야 한다 (FR-019 참조).
- **FR-007**: 시스템은 방장만 "게임 시작" 버튼을 활성화하고, 최소 6명의 플레이어가 있을 때만 게임을 시작할 수 있어야 한다.
- **FR-008**: 시스템은 게임 시작 시 플레이어들을 레드 팀과 블루 팀으로 가능한 균등하게 배정해야 한다. 홀수 플레이어의 경우 레드 팀이 1명 더 많도록 배정한다.
- **FR-009**: 시스템은 정확히 1명의 대통령(블루 팀)과 1명의 폭파범(레드 팀)을 무작위로 배정해야 한다.
- **FR-010**: 시스템은 각 팀에 최소 1명의 스파이를 배정해야 한다. 플레이어 수가 10명 이상인 경우 각 팀당 스파이 수를 2명으로 증가시킨다.
- **FR-011**: 시스템은 나머지 플레이어를 각 팀의 일반 요원으로 배정해야 한다.
- **FR-012**: 시스템은 각 플레이어에게 자신의 역할만 표시하고 다른 플레이어의 역할은 숨겨야 한다.
- **FR-013**: 시스템은 게임 시작 시 플레이어들을 빨간 방과 파란 방으로 무작위 균등 분배해야 한다.
- **FR-014**: 시스템은 각 플레이어에게 자신이 속한 방과 같은 방에 있는 다른 플레이어 목록을 표시해야 한다.
- **FR-015**: 시스템은 방장이 "대기실로 돌아가기" 버튼을 통해 모든 플레이어를 대기실로 복귀시킬 수 있어야 한다.
- **FR-016**: 시스템은 플레이어 연결 상태를 모니터링하고 연결 끊김 시 PLAYER_DISCONNECTED WebSocket 메시지를 통해 다른 플레이어들에게 알려야 한다.
- **FR-020**: 시스템은 플레이어 연결이 끊어진 후 30초의 재접속 유예 기간을 제공해야 하며, 유예 기간 내 재접속 시 게임을 계속 진행할 수 있어야 한다.
- **FR-017**: 시스템은 방장 퇴장 시 자동으로 다음 플레이어에게 방장 권한을 이전해야 한다.
- **FR-018**: 시스템은 존재하지 않는 방 코드 입력 시 적절한 오류 메시지를 표시해야 한다.
- **FR-019**: 시스템은 모든 플레이어에게 실시간으로 게임 상태 변경(플레이어 입장/퇴장, 닉네임 변경, 게임 시작 등)을 WebSocket을 통해 동기화해야 한다.

### Key Entities

- **게임 방 (Game Room)**: 고유 방 코드, 방장 정보, 참가 플레이어 목록, 현재 게임 상태(대기 중/진행 중)
- **플레이어 (Player)**: 닉네임(기본 익명, 변경 가능), 연결 상태, 방장 여부, 역할, 팀, 현재 방 위치
- **게임 세션 (Game Session)**: 참가 플레이어 목록, 팀 배정 정보, 방 배정 정보
- **역할 카드 (Role Card)**: 역할 종류
  - **대통령 (President)**: 블루 팀, 리더 역할, 1명
  - **폭파범 (Bomber)**: 레드 팀, 리더 역할, 1명
  - **레드 팀 스파이 (Red Spy)**: 레드 팀 소속 (오프라인 플레이 시 진영 정보 교환에서 블루 팀으로 보임)
  - **블루 팀 스파이 (Blue Spy)**: 블루 팀 소속 (오프라인 플레이 시 진영 정보 교환에서 레드 팀으로 보임)
  - **레드 팀 요원 (Red Operative)**: 레드 팀 일반 역할
  - **블루 팀 요원 (Blue Operative)**: 블루 팀 일반 역할

**참고**: 스파이의 특수 능력(진영 위장)은 시스템이 아닌 오프라인 게임 진행 중 플레이어들이 직접 활용합니다. 시스템은 역할 배정만 수행합니다.
- **방 배정 (Room Assignment)**: 빨간 방/파란 방, 각 방의 플레이어 목록

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 플레이어는 방 생성 후 5초 이내에 방 코드를 받고 대기실에 입장할 수 있다.
- **SC-002**: 플레이어가 방 코드를 입력한 후 3초 이내에 대기실에 입장하고 다른 플레이어들에게 표시된다.
- **SC-003**: 시스템은 최소 20명의 동시 플레이어(4개 방, 각 방당 5명)를 지원한다.
- **SC-004**: 게임 시작 시 모든 플레이어가 3초 이내에 역할 카드와 방 배정을 받고 게임 화면으로 전환된다.
- **SC-005**: 역할 배분 및 방 배정은 1초 이내에 모든 플레이어에게 반영된다.
- **SC-006**: 게임 진행 중 한 플레이어의 연결이 끊어져도 나머지 플레이어들은 지연 없이 게임을 계속 진행할 수 있다.
- **SC-007**: 90% 이상의 사용자가 별도의 도움말 없이 방 생성 및 입장을 완료할 수 있다.

## Assumptions

- 플레이어들은 게임 규칙을 이미 알고 있으며, 시스템은 역할 배분과 방 배정만 제공한다.
- 실제 게임 진행(역할 공개, 투표 등)은 오프라인에서 플레이어들이 직접 수행한다.
- 플레이어들은 안정적인 인터넷 연결을 가지고 있으며, 일시적인 연결 끊김은 30초 이내에 복구 가능하다고 가정한다.
- 한 게임 방의 최대 플레이어 수는 30명으로 제한한다(보드게임 권장 인원 범위 고려).
- 방 코드는 서버 실행 시간 동안 유효하며, 서버 재시작 시 모든 방이 삭제된다. 게임 데이터는 인메모리 저장소에 휘발성으로 보관된다.
- 플레이어는 데스크톱 브라우저 또는 모바일 브라우저에서 접속하며, 별도의 앱 설치는 필요하지 않다.
- 게임 데이터(플레이어 정보, 역할 배정)는 게임 세션이 종료되면 삭제되며, 영구 저장하지 않는다.
- 익명 닉네임은 "플레이어X" 형식으로 자동 생성되며, 플레이어는 대기실에서 언제든지 변경 가능하다.
- 닉네임 길이는 최소 2자, 최대 20자로 제한한다.
- 스파이 역할은 6-9명일 때 각 팀당 1명, 10명 이상일 때 각 팀당 2명으로 배정한다.

## Out of Scope

다음 기능들은 이번 구현 범위에 포함되지 않습니다:

- 라운드 타이머 및 자동 라운드 진행
- 인질 교환 메커니즘
- 승패 판정 시스템
- 역할 공개 기능 (시스템에서 역할 카드를 다른 플레이어에게 보여주는 기능)
- 진영 정보 교환 및 전체 정보 교환 버튼 (플레이어들이 오프라인에서 직접 수행)
- 게임 결과 화면
- 사용자 계정 시스템 및 로그인 기능
- 게임 통계 및 전적 기록
- 친구 목록 및 초대 기능
- 채팅 또는 음성 통화 기능(플레이어들은 별도의 통신 수단 사용)
- 커스텀 역할 카드 제작 기능
- 게임 리플레이 기능
- 모바일 앱 버전(웹 브라우저 기반만 제공)
- 다국어 지원(한국어만 지원)
- 게임 내 튜토리얼 또는 인터랙티브 가이드
- 방 비밀번호 또는 초대 전용 방 기능
